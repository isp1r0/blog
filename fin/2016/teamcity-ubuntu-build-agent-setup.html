<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>zac anger - angr</title>
  <meta name="description" content="JS Dev, Nix Hacker, Musician">
  <meta name="author" content="Zac Anger">
  <meta name="keywords" content="blog, javascript, js, programming, web development, design, music">
  <meta name="distribution" content="Global">
  <meta name="revisit-after" content="10 Days">
  <meta name="rating" content="General">
  <meta name="refresh" content="10 Days">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" type="text/css" href="/assets/css/highlight/styles/tomorrow-night-eighties.css">
  <script type="text/javascript" src="/assets/css/highlight/highlight.pack.js"></script>

  <link rel="stylesheet" type="text/css" href="/assets/css/screen.css">

  <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="angr" href="/rss/index.xml">
<link rel="canonical" href="http://blog.zacanger.com/2016/teamcity-ubuntu-build-agent-setup.html" />
</head>
<body class="author-template author-blog post-template tag-ubuntu tag-docker tag-aws tag-teamcity">
  <div id="content">
    <div id="content-left">
      <div class="vertical">
        <div class="blog-title-wrap">
        <a id="blog-logo" href="http://blog.zacanger.com"><img src="http://zacanger.com/logo.svg" alt="Blog Logo"></a>
        <h1 class="blog-title"><a href="http://blog.zacanger.com">angr</a></h1>
        </div>

        <div class="blog-description-wrap">
        <h2 class="blog-description">writings from zac anger</h2>
        </div>
    </div>
    </div>

    
<div id="content-main">

  <article class="post tag-ubuntu tag-docker tag-aws tag-teamcity">


    <h2 class="post-title"><a href="/2016/teamcity-ubuntu-build-agent-setup.html">script to set up ec2 build agent for tc</a></h2>
    <span class="post-meta">
      <time datetime="2016-06-06">06 June, 2016</time>
       | tags: <a href="/tag/ubuntu/">ubuntu</a>, <a href="/tag/docker/">docker</a>, <a href="/tag/aws/">aws</a>, <a href="/tag/teamcity/">teamcity</a></span>

    <br>

    <section class="post-content">
      <p>This is a shell script to run on a new Ubuntu EC2 instance to get it
set up as a build agent for TeamCity, running stuff in Docker.</p>
<pre class="hljs"><code><span class="hljs-comment">#!/usr/bin/env bash</span>

<span class="hljs-comment"># start with a t2.large (or maybe medium) ec2 instance</span>
<span class="hljs-comment"># ubuntu, preferably 16.x</span>
<span class="hljs-comment"># needs to have semi-open network access and public IP</span>
<span class="hljs-comment"># to be able to update packages and talk to docker and your</span>
<span class="hljs-comment"># build server</span>
<span class="hljs-comment"># after running this and registering the agent on the TC</span>
<span class="hljs-comment"># server, just use the agent push</span>
<span class="hljs-comment"># or, download the zip and scp it up</span>

<span class="hljs-comment"># new ubuntu instances won&#39;t have pw on default user (ubuntu)</span>
sudo su

apt-get update

apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D

mkdir -p /etc/sources.list.d/
touch /etc/sources.list.d/docker.list
echo &#39;deb <a href="https://apt.dockerproject.org/repo">https://apt.dockerproject.org/repo</a> ubuntu-xenial main&#39; &gt;&gt; /etc/sources.list.d/docker.list
echo &#39;apt_preserve_sources_list: true&#39; &gt;&gt; /etc/cloud/cloud.cfg

if [ command -v lxc-docker ] ; then
  apt-get purge lxc-docker -y
fi

echo &quot;
<span class="hljs-comment">## Note, this file is written by cloud-init on first boot of an instance</span>
<span class="hljs-comment">## modifications made here will not survive a re-bundle.</span>
<span class="hljs-comment">## if you wish to make changes you can:</span>
<span class="hljs-comment">## a.) add &#39;apt_preserve_sources_list: true&#39; to /etc/cloud/cloud.cfg</span>
<span class="hljs-comment">##     or do the same in user-data</span>
<span class="hljs-comment">## b.) add sources in /etc/apt/sources.list.d</span>
<span class="hljs-comment">## c.) make changes to template file /etc/cloud/templates/sources.list.tmpl</span>
<span class="hljs-comment">#</span>

<span class="hljs-comment"># See <a href="http://help.ubuntu.com/community/UpgradeNotes">http://help.ubuntu.com/community/UpgradeNotes</a> for how to upgrade to</span>
<span class="hljs-comment"># newer versions of the distribution.</span>
deb <a href="http://us-east-1.ec2.archive.ubuntu.com/ubuntu/">http://us-east-1.ec2.archive.ubuntu.com/ubuntu/</a> xenial main restricted
deb-src <a href="http://us-east-1.ec2.archive.ubuntu.com/ubuntu/">http://us-east-1.ec2.archive.ubuntu.com/ubuntu/</a> xenial main restricted

<span class="hljs-comment">## Major bug fix updates produced after the final release of the</span>
<span class="hljs-comment">## distribution.</span>
deb <a href="http://us-east-1.ec2.archive.ubuntu.com/ubuntu/">http://us-east-1.ec2.archive.ubuntu.com/ubuntu/</a> xenial-updates main restricted
deb-src <a href="http://us-east-1.ec2.archive.ubuntu.com/ubuntu/">http://us-east-1.ec2.archive.ubuntu.com/ubuntu/</a> xenial-updates main restricted

<span class="hljs-comment">## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu</span>
<span class="hljs-comment">## team. Also, please note that software in universe WILL NOT receive any</span>
<span class="hljs-comment">## review or updates from the Ubuntu security team.</span>
deb <a href="http://us-east-1.ec2.archive.ubuntu.com/ubuntu/">http://us-east-1.ec2.archive.ubuntu.com/ubuntu/</a> xenial universe
deb-src <a href="http://us-east-1.ec2.archive.ubuntu.com/ubuntu/">http://us-east-1.ec2.archive.ubuntu.com/ubuntu/</a> xenial universe
deb <a href="http://us-east-1.ec2.archive.ubuntu.com/ubuntu/">http://us-east-1.ec2.archive.ubuntu.com/ubuntu/</a> xenial-updates universe
deb-src <a href="http://us-east-1.ec2.archive.ubuntu.com/ubuntu/">http://us-east-1.ec2.archive.ubuntu.com/ubuntu/</a> xenial-updates universe

<span class="hljs-comment">## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu</span>
<span class="hljs-comment">## team, and may not be under a free licence. Please satisfy yourself as to</span>
<span class="hljs-comment">## your rights to use the software. Also, please note that software in</span>
<span class="hljs-comment">## multiverse WILL NOT receive any review or updates from the Ubuntu</span>
<span class="hljs-comment">## security team.</span>
deb <a href="http://us-east-1.ec2.archive.ubuntu.com/ubuntu/">http://us-east-1.ec2.archive.ubuntu.com/ubuntu/</a> xenial multiverse
deb-src <a href="http://us-east-1.ec2.archive.ubuntu.com/ubuntu/">http://us-east-1.ec2.archive.ubuntu.com/ubuntu/</a> xenial multiverse
deb <a href="http://us-east-1.ec2.archive.ubuntu.com/ubuntu/">http://us-east-1.ec2.archive.ubuntu.com/ubuntu/</a> xenial-updates multiverse
deb-src <a href="http://us-east-1.ec2.archive.ubuntu.com/ubuntu/">http://us-east-1.ec2.archive.ubuntu.com/ubuntu/</a> xenial-updates multiverse

<span class="hljs-comment">## Uncomment the following two lines to add software from the &#39;backports&#39;</span>
<span class="hljs-comment">## repository.</span>
<span class="hljs-comment">## N.B. software from this repository may not have been tested as</span>
<span class="hljs-comment">## extensively as that contained in the main release, although it includes</span>
<span class="hljs-comment">## newer versions of some applications which may provide useful features.</span>
<span class="hljs-comment">## Also, please note that software in backports WILL NOT receive any review</span>
<span class="hljs-comment">## or updates from the Ubuntu security team.</span>
deb <a href="http://us-east-1.ec2.archive.ubuntu.com/ubuntu/">http://us-east-1.ec2.archive.ubuntu.com/ubuntu/</a> xenial-backports main restricted universe multiverse
deb-src <a href="http://us-east-1.ec2.archive.ubuntu.com/ubuntu/">http://us-east-1.ec2.archive.ubuntu.com/ubuntu/</a> xenial-backports main restricted universe multiverse

<span class="hljs-comment">## Uncomment the following two lines to add software from Canonical&#39;s</span>
<span class="hljs-comment">## &#39;partner&#39; repository.</span>
<span class="hljs-comment">## This software is not part of Ubuntu, but is offered by Canonical and the</span>
<span class="hljs-comment">## respective vendors as a service to Ubuntu users.</span>
<span class="hljs-comment"># deb <a href="http://archive.canonical.com/ubuntu">http://archive.canonical.com/ubuntu</a> xenial partner</span>
<span class="hljs-comment"># deb-src <a href="http://archive.canonical.com/ubuntu">http://archive.canonical.com/ubuntu</a> xenial partner</span>

deb <a href="http://security.ubuntu.com/ubuntu">http://security.ubuntu.com/ubuntu</a> xenial-security main
deb-src <a href="http://security.ubuntu.com/ubuntu">http://security.ubuntu.com/ubuntu</a> xenial-security main
deb <a href="http://security.ubuntu.com/ubuntu">http://security.ubuntu.com/ubuntu</a> xenial-security universe
deb-src <a href="http://security.ubuntu.com/ubuntu">http://security.ubuntu.com/ubuntu</a> xenial-security universe
<span class="hljs-comment"># deb <a href="http://security.ubuntu.com/ubuntu">http://security.ubuntu.com/ubuntu</a> xenial-security multiverse</span>
<span class="hljs-comment"># deb-src <a href="http://security.ubuntu.com/ubuntu">http://security.ubuntu.com/ubuntu</a> xenial-security multiverse</span>
&quot; &gt; /etc/apt/sources.list

apt-get install -y apt-transport-https ca-certificates
apt-get install -y linux-image-extra-$(uname -r) --fix-missing --allow-unauthenticated
apt-get install -y default-jdk unzip docker-engine --fix-missing --allow-unauthenticated
apt-get dist-upgrade -y --allow-unauthenticated --fix-missing
apt-get autoremove
apt-get purge

systemctl daemon-reload
systemctl enable docker
systemctl start docker</code></pre>
    </section>

    <footer class="post-footer">

      <section class="share">
        <a
          class="icon-twitter"
          href="http://twitter.com/share?text=script to set up ec2 build agent for tc&url=http://blog.zacanger.com/2016/teamcity-ubuntu-build-agent-setup.html"
          onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <span class="hidden">Twitter</span>
        </a>
      </section>

    </footer>


  </article>

</div>



    <footer class="site-footer">
      <a class="subscribe icon-feed" href="http://blog.zacanger.com/rss/index.xml"><span class="tooltip">Subscribe!</span></a>
      <div class="">
        <section class="copyright">content by <a href="http://zacanger.com">zac anger</a>.</section>
        <section class="poweredby">
          <a href="http://zacanger.com/LICENSE.txt">under the WTFPL</a> &middot;
          <a href="https://twitter.com/@zacanger">twitter</a> &middot;
          <a href="https://github.com/zacanger">github</a>
        </section>
      </div>
    </footer>

    <script src="/assets/js/jquery.min.js"></script>

    <script type="text/javascript" src="/assets/js/index.js"></script>

  </div>
</body>
</html>

